name: DBT

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

defaults:
  run:
    working-directory: document_fraud

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dbt_user
          POSTGRES_PASSWORD: dbt_password
          POSTGRES_DB: dbt_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dbt
        working-directory: .
        run: pip install dbt-core dbt-postgres

      - name: Create profiles.yml
        working-directory: .
        run: |
          mkdir -p ~/.dbt
          cat > ~/.dbt/profiles.yml << 'EOF'
          document_fraud:
            target: ci
            outputs:
              ci:
                type: postgres
                host: localhost
                port: 5432
                user: dbt_user
                password: dbt_password
                dbname: dbt_test
                schema: public
                threads: 4
          EOF

      - name: Create source tables
        working-directory: .
        run: |
          PGPASSWORD=dbt_password psql -h localhost -U dbt_user -d dbt_test << 'EOF'
          -- Source tables matching sources.yml definitions
          CREATE TABLE public.test_technique_ae_document_controlled (
            id VARCHAR(255) PRIMARY KEY,
            doc_id VARCHAR(255) NOT NULL,
            data_documentcontrolsdata_documentcontrols_anonymized JSONB,
            data_documentcontrolsdata_documentfaceids JSONB,
            data_documentcontrolsdata_status VARCHAR(50),
            data_eventdate DATE NOT NULL,
            data_score VARCHAR(50),
            time TIMESTAMP NOT NULL DEFAULT NOW()
          );

          CREATE TABLE public.test_technique_ae_document_created (
            id VARCHAR(255) PRIMARY KEY,
            data_id_id VARCHAR(255) NOT NULL,
            data_acquisitionid_organizationid VARCHAR(100),
            data_documentclass_documentsubtype VARCHAR(255),
            data_documentclass_documenttype VARCHAR(100),
            data_eventdate DATE NOT NULL,
            time TIMESTAMP NOT NULL DEFAULT NOW()
          );
          EOF

      - name: dbt debug
        run: dbt debug

      - name: dbt deps
        run: dbt deps || true

      - name: dbt compile
        run: dbt compile

      - name: dbt run (staging)
        run: dbt run --select staging

      - name: dbt test (staging)
        run: dbt test --select staging || true
